<html>
<script type="text/javascript">

// The following values are provided/generated when registering a custom Spark web app
var appClientId='Cb93ac731b036b10afc036104d74e558508fd032954a8a0ceeefae551c076a775'; // Custom app ID
var appClientSecret='49594c3b1b5393f55eabba1f0b6294ec08a437e038f55aa447a8164490cfe35b'; // Custom app secret
var appRedirectUri='https://173.36.206.225/spark-sso/sso.html'; // Custom app redirect URI

// Helper function that generates a random alpha/numeric string
var randomString = function(length) {
    var str = "";
    var range = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    for(var i = 0; i < length; i++) {
        str += range.charAt(Math.floor(Math.random() * range.length));
    }
    return str;
}

// Helper function that parses a query string into a dictionary object
var parseQueryStr = function( queryString) {
    var params = {}, keyvals, temp, i, l;
    keyvals = queryString.split("&");  // Split out key/value pairs
    for ( i = 0, l = keyvals.length; i < l; i++ ) {  // Split key/value strings into a dictionary object
        tmp = keyvals[i].split('=');
        params[tmp[0]] = tmp[1];
    }
    return params;
};

// Step #1: Fires when the user clicks the 'Request Auth Code' button
function codeClick() {
	//Build the request URL.  The base URL and next 4 items are typically always the same for Spark web apps
	var requestUrl = 'https://idbroker.webex.com/idb/oauth2/v1/authorize?' + //Spark OAuth2 base URL
		'response_type=code&' + // Requesting the OAuth2 'Authentication Code' flow
		'cisKeepMeSignedInOption=1&' + // Request a multiple-use token
		'service=spark&' +  // Service requested, i.e. Spark
		'scope='+ encodeURIComponent('webexsquare:get_conversation Identity:SCIM') + '&' + // Requested permissions, i.e. Spark conversations and Cisco Identity access
		// The following items are provided by the developer in the source code/config or generated dynamically at run time
		'email='+ encodeURIComponent(document.getElementById('email').value) + '&' + // The Spark user email entered into the HTML form
		'state=' + encodeURIComponent(randomString(63)) + '&' +	// Random string for OAuth2 nonce replay protection
		'client_id=' + encodeURIComponent(appClientId) + '&' + // The custom app Client ID
		'redirect_uri=' + encodeURIComponent(appRedirectUri); // The custom app's Redirect URI
	window.location = requestUrl; // Redirect the browser to the SSO kickoff URL
}

// Step #2: On page load, check if the 'code=' query param is present
// If so user has already authenticated, and  page has been reloaded via the Redirect URI
window.onload = function(e) {
	var params = parseQueryStr(window.location.search.substring(1)); // Parse the query string params into a dictionary
	if (params['code']) { // If the query param 'code' exists, then...
		document.getElementById('code').value = params['code']; // Display the auth code
		document.getElementById('tokenButton').removeAttribute('hidden'); // Reveal the 'Request Auth Token' button
	}
}

// Step #3: Fires when the user clicks the 'Request Auth Token' button
// Takes the auth code and requests an authentication token, needed for API access
function tokenClick() {
	xhttp = new XMLHttpRequest(); // Create an AJAX HTTP request object
	xhttp.onreadystatechange = function() {  // Define a handler, which fires when the request completes
		if (xhttp.readyState == 4 && xhttp.status == 200) { // If request State = 4 (completed) and status = 200 (OK), then...
			var authInfo = JSON.parse(xhttp.responseText); // Parse the JSON response into an object
			document.getElementById('token').value = authInfo['access_token']; // Retrieve the access_token field, and display it
		}
	}

	xhttp.open('POST', 'https://idbroker.webex.com/idb/oauth2/v1/access_token', true); // Initialize the HTTP request object for POST to the access token URL

	xhttp.withCredentials=true; // This request will include user credentials
	auth = btoa('Cb93ac731b036b10afc036104d74e558508fd032954a8a0ceeefae551c076a775'+':'+'49594c3b1b5393f55eabba1f0b6294ec08a437e038f55aa447a8164490cfe35b'); // Base64 encoded credentials, based on app Client ID and Secret
	xhttp.setRequestHeader('Authorization', 'Basic '+auth); // Add the Authorization header with app Basic auth credentials

	// Build the HTML form request body 
	var body = 'grant_type=authorization_code&'+  // This is an OAuth2 Authorization Code request
		'redirect_uri='+encodeURIComponent(appRedirectUri)+'&'+ // Same custom app Redirect URI 
		'code='+encodeURIComponent(document.getElementById('code').value)+'&'+ // User auth code retrieved previously via SSO
		'self_contained_token=true'; // Request all token fields
	xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); // We are sending the content as URL-encoded form data

	xhttp.send(body); // Execute the AJAX HTTP request
}
</script>
	<head>
		<title>Spark SSO Demo</title>
	</head>
	<body>
		Enter Spark User Email: <input id="email"/><button name="codeButton" type="button" onClick="codeClick()">Request Auth Code</button>
		<br><br>
		SSO Auth Code: <input id="code" disabled size=100/><button id="tokenButton" type="button" hidden onClick="tokenClick()">Request Auth Token</button>
		<br><br>
		SSO Auth Token: <textarea id="token" disabled style="vertical-align: top" rows="16" cols="100"></textarea>
	</body>
</html>
